# Test running and analysis

This section describes how to run the tests, and how to analyze the results. We will 
start by preparing the `data-postprocessor`, which will be used to analyze the results 
obtained from TRex.


## Data-postprocessor setup

This can be performed on any machine, for example on the PGEN, or a separate device. 
Using the PGEN can be convenient, as the data files can get quite large.

1. Install Rust. The simplest way is usually to use [`rustup`](https://rustup.rs/)
   ```bash
   curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
   ```
2. Clone this repo, and build the data-processor
   ```bash
   git clone https://github.com/KHTangent/thesis-subprojects
   cd thesis-subprojects/data-postprocessor
   cargo build --release
   ```
3. If you want to install the data-postprocessor system wide, run the following command:
   ```bash
   cargo install --bins --path .
   ```

If you chose to not install the executable system wide, it will be located in
`thesis-subprojects/data-postprocessor/target/release/data-postprocessor`.
It can be freely moved to a more convenient location if you want, it does not have any 
external dependencies.

## Running a test

Now that you have configured your PGEN and your DUT, you can run a test.
A general test has three stages: 

1. Configure the DUT to forward packets between the two interfaces 
   ([section 4](4SoftwareDUT.md)), and apply any other configurations
   you want to try on the DUT.
2. Use TRex to generate latency measurement traffic, which is stored as a data blob.
3. Analyzing this blob using the data-postprocessor.

To run a test, run the commands below on the PGEN. Remember to initialize your ports 
if you have not done so already ([section 3.2](3SoftwarePGEN.md)).

```bash
cd trex-core/scripts
sudo ./_t-rex-64 --cfg path/to/config.yaml --lo -l 190000 -f cap2/dns.yaml -d 60
```

Explanation of parameters:

- `--lo` Send only latency traffic. Latency traffic is the only traffic we can obtain 
  full latency stats for, so only send this
- `-l 190000` Send 190 thousand latency packets every second, giving about 100 Mbps of traffic
- `-f cap2/dns.yaml` TRex requires an input file to run the mode we use, but since we use 
  `--lo`, the contents doesn't affect anything. `cap2/dns.yaml` is a simple minimal file.
- `-d 60` Run test for 60 seconds

After the test has finished, a data blob will be placed in your `trex-core/scripts` directory, 
titled `timestamps-[date]-p0`. This file contains raw values for transmit 
and arrival times of all latency packets generated by TRex.
This file is accepted by the data-postprocessor.



## Viewing results

The data blobs can be analyzed using the data-postprocessor. The data-postprocessor has a 
help page that can be viewed by running `data-postprocessor --help`.

Examples of commands that can be run:

```bash
# Print a summary of anomalies in the data blob, and save a plot to plot.png. 
# Consider 2 consecutive packets with a latency of 500 Âµs an anomaly
# Cut away the first and last second of the data
data-postprocessor timestamps-[date]-p0 validate -n 2 -t 500 --summary-only -c 1 -o plot.png

# Print all of the anomalies in the data blob, and save a plot to plot.png. 
# Consider 2 consecutive packets with a latency of three times the average latency an anomaly
# Cut away the first and last five seconds of the data
data-postprocessor timestamps-[date]-p0 validate -n 2 -d 3 --summary-only -c 5 -o plot.png

# Plot latencies of all packets in the data blob. Include all data
data-postprocessor timestamps-[date]-p0 plot -p latency -o plot.png
```


If you are able to run tests, it is recommended to spend some time on tuning 
and validating your setup. This is described in the last section, 
[Tuning the PGEN](6TuningPGEN.md).



